<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK Wireless Queue System</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --registrar-color: #2563eb; 
            --finance-color: #059669; 
            --dark: #0f172a; 
            --card-bg: rgba(30, 41, 59, 0.95);
        }
        
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #000; color: #fff; overflow: hidden; }
        
        /* VIDEO AD OVERLAY (Front Layer) */
        #videoAdOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999; 
            display: none; 
        }
        #adVideo { width: 100%; height: 100%; object-fit: cover; }

        /* HEADER */
        .inst-header { 
            background: white; padding: 10px 20px; border-bottom: 4px solid var(--registrar-color); 
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .school-logo { height: 50px; margin-bottom: 2px; }
        .inst-header h1 { margin: 0; font-size: 0.9rem; color: var(--dark); text-transform: uppercase; }
        .header-right { position: absolute; right: 20px; top: 15px; }
        .admin-icon { cursor: pointer; width: 20px; fill: #cbd5e1; }

        /* NAV */
        nav { background: var(--dark); padding: 10px; display: none; gap: 10px; justify-content: center; }
        nav.show-menu { display: flex; }
        nav button { background: #334155; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; }

        .view { display: none; min-height: 85vh; padding: 20px; box-sizing: border-box; }
        .view.active { display: flex; flex-direction: column; align-items: center; }

        /* MONITOR UI */
        .monitor-container { display: flex; width: 100%; height: 80vh; gap: 20px; margin-top: 20px; }
        .monitor-panel { 
            flex: 1; display: flex; flex-direction: column; border-radius: 30px; 
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); overflow: hidden;
        }
        .mon-number { font-size: 10rem; font-weight: 900; font-family: monospace; color: #38bdf8; margin: 0; }
        .mon-name { font-size: 2.5rem; font-weight: 600; text-transform: capitalize; color: #fff; }
        
        .waiting-list { flex: 1.5; padding: 20px; background: rgba(0,0,0,0.3); }
        .waiting-row {
            display: flex; justify-content: space-between; padding: 12px; 
            background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px;
        }
        .wait-ticket { font-weight: 800; color: #38bdf8; font-size: 1.4rem; }

        /* KIOSK/STAFF */
        .kiosk-card { background: white; padding: 40px; border-radius: 24px; color: var(--dark); text-align: center; }
        .name-input { width: 100%; padding: 15px; font-size: 1.2rem; border-radius: 12px; border: 2px solid #ddd; margin-bottom: 20px; text-align: center; }
        .call-btn { width: 200px; height: 200px; border-radius: 50%; color: white; font-weight: 900; cursor: pointer; border: 8px solid #f1f5f9; }
    </style>
</head>
<body>

<div id="videoAdOverlay">
    <video id="adVideo" muted playsinline>
        <source src="videos/MAKERTING2023.MP4" type="video/mp4">
    </video>
</div>

<header class="inst-header">
    <img src="images/logo.png" alt="ARK Logo" class="school-logo">
    <h1>ARK Technological Institute Education System Inc.</h1>
    <div class="header-right">
        <svg class="admin-icon" onclick="unlockMenu()" viewBox="0 0 24 24"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z"/></svg>
    </div>
</header>

<nav id="mainNav">
    <button onclick="showView('kioskView')">KIOSK</button>
    <button onclick="showView('staffView')">STAFF PANEL</button>
    <button onclick="showView('monitorView')" class="active">MONITOR</button>
    <button onclick="resetSystem()" style="background:#f59e0b">RESET</button>
</nav>

<div id="kioskView" class="view">
    <div class="kiosk-card">
        <h2>Queue Registration</h2>
        <input type="text" id="studentName" class="name-input" placeholder="Enter Full Name">
        <button onclick="generateTicket('REGISTRAR', 'R')" style="background:var(--registrar-color); width:100%; padding:20px; color:white; border:none; border-radius:15px; cursor:pointer;">REGISTRAR</button>
        <button onclick="generateTicket('FINANCE', 'F')" style="background:var(--finance-color); width:100%; padding:20px; color:white; border:none; border-radius:15px; cursor:pointer; margin-top:10px;">FINANCE</button>
    </div>
</div>

<div id="staffView" class="view">
    <div style="display:flex; width:100%; max-width:900px; background:white; color:#000; border-radius:20px; overflow:hidden;">
        <div style="width:200px; background:#f1f5f9; padding:20px;">
            <button onclick="switchDept('REGISTRAR')" style="width:100%; padding:10px; margin-bottom:10px;">REGISTRAR</button>
            <button onclick="switchDept('FINANCE')" style="width:100%; padding:10px;">FINANCE</button>
        </div>
        <div style="flex:1; padding:40px; text-align:center;">
            <div id="ws-REGISTRAR" class="dept-ws">
                <h2>Registrar Counter</h2>
                <div id="current-name-REGISTRAR">---</div>
                <button class="call-btn" style="background:var(--registrar-color)" onclick="callNext('REGISTRAR')">CALL NEXT</button>
            </div>
            <div id="ws-FINANCE" class="dept-ws" style="display:none;">
                <h2>Finance Counter</h2>
                <div id="current-name-FINANCE">---</div>
                <button class="call-btn" style="background:var(--finance-color)" onclick="callNext('FINANCE')">CALL NEXT</button>
            </div>
        </div>
    </div>
</div>

<div id="monitorView" class="view active">
    <div class="monitor-container">
        <div class="monitor-panel">
            <div style="flex:3; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div style="color:var(--registrar-color); font-weight:800;">REGISTRAR</div>
                <div class="mon-number" id="mon-num-REGISTRAR">---</div>
                <div class="mon-name" id="mon-name-REGISTRAR">Welcome</div>
            </div>
            <div class="waiting-list">
                <div style="text-align:center; color:#94a3b8; font-size:0.8rem; margin-bottom:10px;">NEXT IN LINE</div>
                <div id="next-list-REGISTRAR"></div>
            </div>
        </div>
        <div class="monitor-panel">
            <div style="flex:3; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div style="color:var(--finance-color); font-weight:800;">FINANCE</div>
                <div class="mon-number" id="mon-num-FINANCE" style="color:#4ade80">---</div>
                <div class="mon-name" id="mon-name-FINANCE">Welcome</div>
            </div>
            <div class="waiting-list">
                <div style="text-align:center; color:#94a3b8; font-size:0.8rem; margin-bottom:10px;">NEXT IN LINE</div>
                <div id="next-list-FINANCE"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDrySDxpUqTMAzom9o1B3ZaGkL__2kx19A",
        authDomain: "ark-queue-system.firebaseapp.com",
        databaseURL: "https://ark-queue-system-default-rtdb.firebaseio.com",
        projectId: "ark-queue-system",
        storageBucket: "ark-queue-system.firebasestorage.app",
        messagingSenderId: "1087161355859",
        appId: "1:1087161355859:web:f17ab0505bc100d0f440a6",
        measurementId: "G-XXEPW2FK59"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- ENHANCED VIDEO LOGIC ---
    let idleTimer;
    const AD_VIDEO = document.getElementById('adVideo');
    const AD_OVERLAY = document.getElementById('videoAdOverlay');
    
    // List your 3 videos here
    const videoPlaylist = [
        "videos/MAKERTING2023.MP4",
        "videos/video2.MP4", // Update with your actual file names
        "videos/video3.MP4"
    ];
    let currentVideoIndex = 0;

    // Listen for when the current video ends to play the next one
    AD_VIDEO.onended = function() {
        currentVideoIndex++;
        if (currentVideoIndex >= videoPlaylist.length) {
            currentVideoIndex = 0; // Restart from first video
        }
        playCurrentVideo();
    };

    function playCurrentVideo() {
        AD_VIDEO.src = videoPlaylist[currentVideoIndex];
        AD_VIDEO.play();
    }

    function showAd() {
        AD_OVERLAY.style.display = 'block';
        playCurrentVideo();
    }

    function hideAd() {
        AD_OVERLAY.style.display = 'none';
        AD_VIDEO.pause();
        resetIdleTimer();
    }

    function resetIdleTimer() {
        clearTimeout(idleTimer);
        // Returns to videos after 20 seconds of no calls
        idleTimer = setTimeout(showAd, 20000); 
    }
    // ----------------------------

    async function callNext(dept) {
        const snap = await db.ref('waiting_' + dept).limitToFirst(1).get();
        if(snap.exists()) {
            const key = Object.keys(snap.val())[0];
            const data = snap.val()[key];
            await db.ref('waiting_' + dept + '/' + key).remove();
            await db.ref('currentCall').set({ ticket: data.ticket, name: data.name, dept: dept, time: Date.now() });
        }
    }

    db.ref('currentCall').on('value', (snap) => {
        const data = snap.val();
        if(data && data.dept !== "NONE") {
            hideAd(); // Hide video playlist immediately when calling
            document.getElementById('mon-num-' + data.dept).innerText = data.ticket;
            document.getElementById('mon-name-' + data.dept).innerText = data.name;
            
            if (Date.now() - data.time < 2000) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(`Now serving, ${data.name}, ticket ${data.ticket}`);
                window.speechSynthesis.speak(msg);
            }
        }
    });

    ['REGISTRAR', 'FINANCE'].forEach(dept => {
        db.ref('waiting_' + dept).on('value', (snap) => {
            const listEl = document.getElementById('next-list-' + dept);
            listEl.innerHTML = "";
            let i = 0;
            snap.forEach(child => {
                if(i < 4) {
                    const row = child.val();
                    const div = document.createElement('div');
                    div.className = 'waiting-row';
                    div.innerHTML = `<span style="text-transform:capitalize">${row.name}</span><span class="wait-ticket">${row.ticket}</span>`;
                    listEl.appendChild(div);
                }
                i++;
            });
        });
    });

    function unlockMenu() { if(prompt("Pass:") === "admin123") document.getElementById('mainNav').classList.add('show-menu'); }
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function switchDept(dept) {
        document.querySelectorAll('.dept-ws').forEach(d => d.style.display = 'none');
        document.getElementById('ws-' + dept).style.display = 'block';
    }

    async function generateTicket(dept, prefix) {
        const name = document.getElementById('studentName').value.trim();
        if(!name) return alert("Enter Name");
        const snap = await db.ref('last_' + dept).get();
        let num = (snap.val() || 0) + 1;
        await db.ref('last_' + dept).set(num);
        await db.ref('waiting_' + dept).push({ ticket: prefix + num.toString().padStart(3, '0'), name: name });
        document.getElementById('studentName').value = "";
    }

    resetIdleTimer();
</script>
</body>
</html>
