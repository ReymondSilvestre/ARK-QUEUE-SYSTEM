<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK Wireless Queue System</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --registrar-color: #2563eb; 
            --finance-color: #059669; 
            --dark: #0f172a; 
            --body-bg: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-main: #1e293b;
            --text-muted: #64748b;
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; 
            margin: 0; 
            background: var(--body-bg); 
            color: var(--text-main); 
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- ENHANCED RESPONSIVE FULL SCREEN VIDEO --- */
        #screensaver-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            z-index: 9999;
            background: #000; /* Ensures blank spaces are black */
            transition: opacity 0.8s ease, visibility 0.8s;
            visibility: hidden;
            opacity: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #screensaver-container.active {
            visibility: visible;
            opacity: 1;
        }

        #screensaver-container video {
            width: 100%;
            height: 100%;
            /* Default for large screens: Fill the area */
            object-fit: cover; 
            object-position: center;
        }

        /* HEADER */
        .inst-header { 
            background: white; 
            padding: 1rem; 
            border-bottom: 5px solid var(--registrar-color); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: relative;
            z-index: 100;
        }
        .school-logo { height: 50px; width: auto; margin-bottom: 5px; }
        .inst-header h1 { 
            margin: 0; 
            font-size: 1rem; 
            font-weight: 800; 
            color: var(--dark); 
            text-transform: uppercase; 
            line-height: 1.2;
        }

        /* NAVIGATION - Admin Only */
        nav { 
            background: var(--dark); 
            padding: 8px; 
            display: none; 
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center; 
            z-index: 101;
        }
        nav.show-menu { display: flex; }
        nav button { 
            background: #334155; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.8rem;
            font-weight: bold; 
        }

        /* VIEW CONTAINER */
        .view { display: none; padding: 1rem; width: 100%; flex: 1; }
        .view.active { display: flex; flex-direction: column; align-items: center; }

        /* MONITOR UI */
        .monitor-container { 
            display: grid;
            grid-template-columns: 1fr;
            width: 100%; 
            max-width: 1600px;
            gap: 1.5rem; 
            margin: auto;
        }
        .monitor-panel { 
            background: var(--card-bg); 
            border-radius: 24px; 
            overflow: hidden; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            text-align: center;
        }
        .mon-header-label { font-weight: 900; font-size: 1.5rem; letter-spacing: 2px; padding-top: 20px; }
        .mon-number { font-size: 4.5rem; font-weight: 900; font-family: monospace; margin: 10px 0; }
        .mon-name { font-size: 1.2rem; font-weight: 700; color: var(--text-main); padding-bottom: 20px; }

        .waiting-list { background: #f8fafc; padding: 1rem; border-top: 1px solid #e2e8f0; flex: 1; }
        .waiting-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 15px; 
            background: white; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            font-size: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }

        /* KIOSK STYLES */
        .kiosk-card { background: white; padding: 2rem; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        .name-input { width: 100%; padding: 1.2rem; font-size: 1.2rem; border-radius: 12px; border: 2px solid #e2e8f0; margin-bottom: 1.5rem; text-align: center; outline-color: var(--registrar-color); }
        .btn-reg { background: var(--registrar-color); color: white; width: 100%; padding: 1.5rem; border: none; border-radius: 15px; font-weight: 900; font-size: 1.3rem; cursor: pointer; margin-bottom: 1rem; }
        .btn-fin { background: var(--finance-color); color: white; width: 100%; padding: 1.5rem; border: none; border-radius: 15px; font-weight: 900; font-size: 1.3rem; cursor: pointer; }

        /* STAFF PANEL */
        .staff-container { display: flex; flex-direction: column; width: 100%; max-width: 900px; background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .staff-sidebar { display: flex; background: #f1f5f9; }
        .staff-sidebar button { flex: 1; padding: 1.2rem; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .staff-sidebar button.active-dept { background: white; color: var(--registrar-color); box-shadow: inset 0 -4px 0 var(--registrar-color); }
        .call-btn { width: 180px; height: 180px; border-radius: 50%; color: white; border: 10px solid #f1f5f9; font-size: 1.2rem; font-weight: 900; cursor: pointer; transition: transform 0.2s; }

        /* MODAL */
        #ticketModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; padding: 2rem; border-radius: 28px; text-align: center; width: 100%; max-width: 400px; }
        .modal-ticket { font-size: 5rem; font-weight: 900; color: var(--registrar-color); margin: 10px 0; }

        /* --- MEDIA QUERIES --- */
        
        /* Mobile Specific: Show full video with blank spaces */
        @media (max-width: 767px) {
            #screensaver-container video {
                object-fit: contain; /* Shows full video frame on small devices */
            }
        }

        @media (min-width: 768px) {
            .inst-header { padding: 1.5rem; }
            .school-logo { height: 70px; }
            .inst-header h1 { font-size: 1.5rem; }
            .monitor-container { grid-template-columns: 1fr 1fr; }
            .mon-number { font-size: 6rem; }
            .staff-sidebar { flex-direction: column; width: 200px; }
            .staff-container { flex-direction: row; min-height: 450px; }
            .staff-sidebar button.active-dept { box-shadow: inset -4px 0 0 var(--registrar-color); }
        }

        @media (min-width: 1200px) {
            .inst-header h1 { font-size: 2rem; }
            .mon-number { font-size: 8rem; }
            .mon-header-label { font-size: 2.5rem; }
        }
    </style>
</head>
<body>

<div id="screensaver-container">
    <video id="idleVideo" muted loop playsinline>
        <source src="videos/MAKERTING2023.mp4" type="video/mp4">
    </video>
</div>

<div id="ticketModal">
    <div class="modal-content">
        <h2 style="margin:0; color:var(--text-muted); font-size: 1rem;">YOUR TICKET NUMBER</h2>
        <div class="modal-ticket" id="displayTicket">---</div>
        <div class="modal-name" id="displayName" style="font-weight: bold; font-size: 1.4rem;">---</div>
        <p style="color: #64748b;">Please take a photo of your ticket.</p>
        <button onclick="closeModal()" style="background:var(--dark); color:white; border:none; padding:15px; border-radius:12px; font-weight:bold; width: 100%; cursor: pointer; font-size: 1.1rem;">OK, GOT IT</button>
    </div>
</div>

<header class="inst-header">
    <img src="images/logo.png" alt="ARK Logo" class="school-logo">
    <h1>ARK Technological Institute <br> Education System Inc.</h1>
    <div class="header-right" style="position: absolute; right: 20px; top: 20px;">
        <svg class="admin-icon" style="width:24px; cursor:pointer; fill:#cbd5e1;" onclick="unlockMenu()" viewBox="0 0 24 24">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z"/>
        </svg>
    </div>
</header>

<nav id="mainNav">
    <button onclick="showView('kioskView')">KIOSK MODE</button>
    <button onclick="showView('staffView')">STAFF PANEL</button>
    <button onclick="showView('monitorView')">MONITOR SCREEN</button>
    <button onclick="resetSystem()" style="background: #ef4444;">RESET SYSTEM</button>
</nav>

<div id="kioskView" class="view">
    <div class="kiosk-card">
        <h2 style="margin-top:0;">Queue Registration</h2>
        <input type="text" id="studentName" class="name-input" placeholder="Enter Full Name">
        <button class="btn-reg" onclick="generateTicket('REGISTRAR', 'R')">REGISTRAR</button>
        <button class="btn-fin" onclick="generateTicket('FINANCE', 'F')">FINANCE</button>
    </div>
</div>

<div id="staffView" class="view">
    <div class="staff-container">
        <div class="staff-sidebar">
            <button id="btn-tab-REGISTRAR" onclick="switchDept('REGISTRAR')" class="active-dept">REGISTRAR</button>
            <button id="btn-tab-FINANCE" onclick="switchDept('FINANCE')">FINANCE</button>
        </div>
        <div style="flex:1; padding:2rem; text-align:center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div id="ws-REGISTRAR" class="dept-ws">
                <h2 style="color:var(--registrar-color);">Registrar Counter</h2>
                <p>Waiting: <b id="count-REGISTRAR">0</b></p>
                <div id="current-name-REGISTRAR" style="margin: 20px 0; font-weight: bold; font-size: 1.4rem; background: #f8fafc; padding: 10px; border-radius: 10px;">---</div>
                <button class="call-btn" style="background:var(--registrar-color)" onclick="callNext('REGISTRAR')">CALL NEXT</button>
            </div>
            <div id="ws-FINANCE" class="dept-ws" style="display:none;">
                <h2 style="color:var(--finance-color);">Finance Counter</h2>
                <p>Waiting: <b id="count-FINANCE">0</b></p>
                <div id="current-name-FINANCE" style="margin: 20px 0; font-weight: bold; font-size: 1.4rem; background: #f8fafc; padding: 10px; border-radius: 10px;">---</div>
                <button class="call-btn" style="background:var(--finance-color)" onclick="callNext('FINANCE')">CALL NEXT</button>
            </div>
        </div>
    </div>
</div>

<div id="monitorView" class="view active">
    <div class="monitor-container">
        <div class="monitor-panel">
            <div class="mon-header-label" style="color:var(--registrar-color)">REGISTRAR</div>
            <div class="mon-number" id="mon-num-REGISTRAR" style="color:var(--registrar-color)">---</div>
            <div class="mon-name" id="mon-name-REGISTRAR">Welcome</div>
            <div class="waiting-list" id="next-list-REGISTRAR"></div>
        </div>
        <div class="monitor-panel">
            <div class="mon-header-label" style="color:var(--finance-color)">FINANCE</div>
            <div class="mon-number" id="mon-num-FINANCE" style="color:var(--finance-color)">---</div>
            <div class="mon-name" id="mon-name-FINANCE">Welcome</div>
            <div class="waiting-list" id="next-list-FINANCE"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDrySDxpUqTMAzom9o1B3ZaGkL__2kx19A",
        authDomain: "ark-queue-system.firebaseapp.com",
        databaseURL: "https://ark-queue-system-default-rtdb.firebaseio.com",
        projectId: "ark-queue-system",
        storageBucket: "ark-queue-system.firebasestorage.app",
        messagingSenderId: "1087161355859",
        appId: "1:1087161355859:web:f17ab0505bc100d0f440a6",
        measurementId: "G-XXEPW2FK59"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let screensaverTimer;
    let currentActiveView = 'monitorView';

    function unlockMenu() { 
        if(prompt("Admin Password:") === "") {
            document.getElementById('mainNav').classList.add('show-menu');
        } 
    }

    function showView(id) {
        currentActiveView = id;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('mainNav').classList.remove('show-menu');
        if(id !== 'monitorView') {
            toggleScreensaver(false);
        } else {
            resetIdleTimer();
        }
    }

    async function resetSystem() {
        if(confirm("Are you sure you want to reset all ticket counts?")) {
            await db.ref('/').update({
                'last_REGISTRAR': 0, 'last_FINANCE': 0,
                'waiting_REGISTRAR': null, 'waiting_FINANCE': null,
                'currentCall': { ticket: '---', name: 'Welcome', dept: 'NONE', time: 0 }
            });
            location.reload();
        }
    }

    function toggleScreensaver(show) {
        const ss = document.getElementById('screensaver-container');
        const video = document.getElementById('idleVideo');
        if (show && currentActiveView === 'monitorView') {
            ss.classList.add('active');
            video.play().catch(() => console.log("User interaction required for video"));
        } else {
            ss.classList.remove('active');
            video.pause();
        }
    }

    function resetIdleTimer() {
        clearTimeout(screensaverTimer);
        screensaverTimer = setTimeout(() => {
            toggleScreensaver(true);
        }, 25000); 
    }

    // Database Listeners
    db.ref('currentCall').on('value', (snap) => {
        const data = snap.val();
        if(data && data.dept !== "NONE") {
            toggleScreensaver(false);
            resetIdleTimer();

            const numEl = document.getElementById('mon-num-' + data.dept);
            const nameEl = document.getElementById('mon-name-' + data.dept);
            if(numEl) numEl.innerText = data.ticket;
            if(nameEl) nameEl.innerText = data.name;

            const staffDisplay = document.getElementById('current-name-' + data.dept);
            if(staffDisplay) staffDisplay.innerText = `${data.name} (${data.ticket})`;

            if (Date.now() - data.time < 3000) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(`Now serving ${data.name}. Ticket ${data.ticket}`);
                msg.rate = 0.85;
                window.speechSynthesis.speak(msg);
            }
        }
    });

    ['REGISTRAR', 'FINANCE'].forEach(dept => {
        db.ref('waiting_' + dept).on('value', (snap) => {
            const listEl = document.getElementById('next-list-' + dept);
            const countEl = document.getElementById('count-' + dept);
            if(!listEl) return;
            listEl.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                count++;
                if(count > 4) return;
                const row = child.val();
                const div = document.createElement('div');
                div.className = 'waiting-row';
                div.innerHTML = `<span>${row.name}</span><b style="color:var(--registrar-color)">${row.ticket}</b>`;
                listEl.appendChild(div);
            });
            if(countEl) countEl.innerText = count;
        });
    });

    async function callNext(dept) {
        const snap = await db.ref('waiting_' + dept).limitToFirst(1).get();
        if(snap.exists()) {
            const key = Object.keys(snap.val())[0];
            const data = snap.val()[key];
            await db.ref('waiting_' + dept + '/' + key).remove();
            await db.ref('currentCall').set({ ticket: data.ticket, name: data.name, dept: dept, time: Date.now() });
        } else {
            alert("No students in queue.");
        }
    }

    function switchDept(dept) {
        document.querySelectorAll('.dept-ws').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.staff-sidebar button').forEach(b => b.classList.remove('active-dept'));
        document.getElementById('ws-' + dept).style.display = 'block';
        document.getElementById('btn-tab-' + dept).classList.add('active-dept');
    }

    async function generateTicket(dept, prefix) {
        const input = document.getElementById('studentName');
        const name = input.value.trim();
        if(!name) return alert("Please enter your name");

        const snap = await db.ref('last_' + dept).get();
        let num = (snap.val() || 0) + 1;
        const ticketID = prefix + num.toString().padStart(3, '0');
        
        await db.ref('last_' + dept).set(num);
        await db.ref('waiting_' + dept).push({ ticket: ticketID, name: name });
        
        document.getElementById('displayTicket').innerText = ticketID;
        document.getElementById('displayName').innerText = name;
        document.getElementById('ticketModal').style.display = 'flex';
        
        input.value = ""; 
        setTimeout(closeModal, 8000);
    }

    function closeModal() {
        document.getElementById('ticketModal').style.display = 'none';
    }

    window.onload = () => {
        if(currentActiveView === 'monitorView') resetIdleTimer();
    }
</script>
</body>
</html>
