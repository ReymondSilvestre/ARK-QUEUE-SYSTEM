<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARK Wireless Queue System</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --registrar-color: #2563eb; 
            --finance-color: #059669; 
            --dark: #0f172a; 
            --body-bg: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-muted: #64748b;
        }
        
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            margin: 0; 
            background: var(--body-bg); 
            color: var(--text-main); 
            min-height: 100vh;
            overflow: hidden; /* Prevent scrolling when screensaver is active */
        }

        /* --- RESPONSIVE FULL SCREEN VIDEO --- */
        #screensaver-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999; /* Highest priority: above header and content */
            background: black;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
            visibility: hidden;
            opacity: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #screensaver-container.active {
            visibility: visible;
            opacity: 1;
        }

        #screensaver-container video {
            width: 100%;
            height: 100%;
            /* This property makes the video fit the screen responsively */
            object-fit: cover; 
        }

        /* HEADER */
        .inst-header { 
            background: white; 
            padding: 15px 20px; 
            border-bottom: 5px solid var(--registrar-color); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            gap: 5px;
            position: relative;
            z-index: 100;
        }
        .school-logo { height: 60px; width: auto; }
        .inst-header h1 { 
            margin: 5px 0 0; 
            font-size: 1.1rem; 
            font-weight: 800; 
            color: var(--dark); 
            text-transform: uppercase; 
            line-height: 1.2;
        }

        @media (min-width: 768px) {
            .inst-header { padding: 20px 40px; }
            .school-logo { height: 80px; }
            .inst-header h1 { font-size: 1.8rem; }
        }

        .header-right { position: absolute; right: 15px; top: 15px; }
        .admin-icon { cursor: pointer; width: 25px; height: 25px; fill: #cbd5e1; }

        /* NAVIGATION */
        nav { 
            background: var(--dark); 
            padding: 10px; 
            display: none; 
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center; 
            position: relative;
            z-index: 101;
        }
        nav.show-menu { display: flex; }
        nav button { 
            background: #334155; 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 0.85rem;
            font-weight: bold; 
        }

        /* VIEW CONTAINER */
        .view { display: none; padding: 20px; width: 100%; box-sizing: border-box; }
        .view.active { display: flex; flex-direction: column; align-items: center; }

        /* MONITOR UI RESPONSIVENESS */
        .monitor-container { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            max-width: 1600px;
            gap: 20px; 
            margin-top: 10px; 
        }
        .monitor-panel { 
            flex: 1; 
            background: var(--card-bg); 
            border-radius: 20px; 
            overflow: hidden; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }
        .mon-header-label { font-weight: 900; font-size: 1.8rem; letter-spacing: 2px; margin-top: 15px; }
        .mon-number { font-size: 5rem; font-weight: 900; font-family: 'Courier New', monospace; margin: 5px 0; }
        .mon-name { font-size: 1.4rem; font-weight: 700; color: var(--text-main); padding: 0 10px 20px; }

        .waiting-list { background: rgba(241, 245, 249, 0.8); padding: 15px; border-top: 1px solid #e2e8f0; flex-grow: 1; }
        .waiting-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 15px; 
            background: white; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            font-size: 1.1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .wait-ticket { font-weight: 800; color: var(--registrar-color); }

        @media (min-width: 1024px) {
            .monitor-container { flex-direction: row; height: 72vh; }
            .mon-number { font-size: 8rem; }
            .mon-header-label { font-size: 3rem; }
            .mon-name { font-size: 2rem; }
        }

        /* KIOSK & STAFF */
        .kiosk-card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; margin-top: 20px; }
        .name-input { width: 100%; padding: 18px; font-size: 1.3rem; border-radius: 12px; border: 2px solid #e2e8f0; margin-bottom: 25px; text-align: center; box-sizing: border-box; outline-color: var(--registrar-color); }
        .staff-container { display: flex; flex-direction: column; width: 100%; max-width: 1000px; background: white; border-radius: 24px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .staff-sidebar { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .staff-sidebar button { flex: 1; padding: 20px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .staff-sidebar button.active-dept { background: white; color: var(--registrar-color); box-shadow: inset 0 -4px 0 var(--registrar-color); }
        .call-btn { width: 220px; height: 220px; border-radius: 50%; color: white; border: 12px solid #f1f5f9; font-size: 1.5rem; font-weight: 900; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .call-btn:active { transform: scale(0.95); }

        @media (min-width: 768px) {
            .staff-container { flex-direction: row; min-height: 500px; }
            .staff-sidebar { flex-direction: column; width: 220px; border-bottom: none; border-right: 1px solid #e2e8f0; }
            .staff-sidebar button.active-dept { box-shadow: inset -4px 0 0 var(--registrar-color); }
        }

        /* MODAL */
        #ticketModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; padding: 40px; border-radius: 32px; text-align: center; width: 100%; max-width: 420px; }
        .modal-ticket { font-size: 6rem; font-weight: 900; color: var(--registrar-color); margin: 10px 0; }
    </style>
</head>
<body>

<div id="screensaver-container">
    <video id="idleVideo" autoplay muted loop playsinline>
        <source src="videos/MAKERTING2023.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<div id="ticketModal">
    <div class="modal-content">
        <h2 style="margin:0; color:var(--text-muted); font-size: 1.1rem; letter-spacing: 1px;">YOUR TICKET NUMBER</h2>
        <div class="modal-ticket" id="displayTicket">---</div>
        <div class="modal-name" id="displayName" style="font-weight: 800; font-size: 1.5rem; color: var(--dark);">---</div>
        <p style="color: #64748b; font-size: 1rem; margin-top: 15px;">Please take a photo or remember your number.</p>
        <button onclick="closeModal()" style="background:var(--dark); color:white; border:none; padding:18px 40px; border-radius:15px; font-weight:bold; width: 100%; margin-top: 20px; cursor: pointer; font-size: 1.1rem;">GOT IT</button>
    </div>
</div>

<header class="inst-header">
    <img src="images/logo.png" alt="ARK Logo" class="school-logo">
    <h1>ARK Technological Institute <br> Education System Inc.</h1>
    <div class="header-right">
        <svg class="admin-icon" onclick="unlockMenu()" viewBox="0 0 24 24">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
            <path d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z"/>
        </svg>
    </div>
</header>

<nav id="mainNav">
    <button onclick="showView('kioskView')">KIOSK MODE</button>
    <button onclick="showView('staffView')">STAFF PANEL</button>
    <button onclick="showView('monitorView')">MONITOR SCREEN</button>
    <button onclick="resetSystem()" style="background: #ef4444;">RESET ALL</button>
</nav>

<div id="kioskView" class="view">
    <div class="kiosk-card">
        <h2 style="margin-top:0; color: var(--dark);">Queue Registration</h2>
        <p style="color: var(--text-muted); margin-bottom: 20px;">Enter your name to get a ticket</p>
        <input type="text" id="studentName" class="name-input" placeholder="Full Name">
        <button onclick="generateTicket('REGISTRAR', 'R')" style="background:var(--registrar-color); width:100%; padding:22px; color:white; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:1.4rem; margin-bottom:15px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);">REGISTRAR</button>
        <button onclick="generateTicket('FINANCE', 'F')" style="background:var(--finance-color); width:100%; padding:22px; color:white; border:none; border-radius:15px; cursor:pointer; font-weight:bold; font-size:1.4rem; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);">FINANCE</button>
    </div>
</div>

<div id="staffView" class="view">
    <div class="staff-container">
        <div class="staff-sidebar">
            <button id="btn-tab-REGISTRAR" onclick="switchDept('REGISTRAR')" class="active-dept">REGISTRAR</button>
            <button id="btn-tab-FINANCE" onclick="switchDept('FINANCE')">FINANCE</button>
        </div>
        <div style="flex:1; padding:40px; text-align:center; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div id="ws-REGISTRAR" class="dept-ws">
                <h2 style="color:var(--registrar-color); font-size: 2rem; margin-bottom: 5px;">Registrar Counter</h2>
                <p style="font-size: 1.2rem; color: var(--text-muted);">In line: <b id="count-REGISTRAR" style="color: var(--dark);">0</b></p>
                <div id="current-name-REGISTRAR" style="margin: 25px 0; font-weight: 800; font-size: 1.5rem; color: var(--dark); background: #f1f5f9; padding: 15px; border-radius: 12px;">---</div>
                <button class="call-btn" style="background:var(--registrar-color); box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);" onclick="callNext('REGISTRAR')">CALL NEXT</button>
            </div>
            <div id="ws-FINANCE" class="dept-ws" style="display:none;">
                <h2 style="color:var(--finance-color); font-size: 2rem; margin-bottom: 5px;">Finance Counter</h2>
                <p style="font-size: 1.2rem; color: var(--text-muted);">In line: <b id="count-FINANCE" style="color: var(--dark);">0</b></p>
                <div id="current-name-FINANCE" style="margin: 25px 0; font-weight: 800; font-size: 1.5rem; color: var(--dark); background: #f1f5f9; padding: 15px; border-radius: 12px;">---</div>
                <button class="call-btn" style="background:var(--finance-color); box-shadow: 0 10px 30px rgba(5, 150, 105, 0.4);" onclick="callNext('FINANCE')">CALL NEXT</button>
            </div>
        </div>
    </div>
</div>

<div id="monitorView" class="view active">
    <div class="monitor-container">
        <div class="monitor-panel">
            <div style="text-align: center; padding: 25px;">
                <div class="mon-header-label" style="color:var(--registrar-color)">REGISTRAR</div>
                <div class="mon-number" id="mon-num-REGISTRAR" style="color: var(--registrar-color);">---</div>
                <div class="mon-name" id="mon-name-REGISTRAR">Please wait...</div>
            </div>
            <div class="waiting-list" id="next-list-REGISTRAR"></div>
        </div>
        <div class="monitor-panel">
            <div style="text-align: center; padding: 25px;">
                <div class="mon-header-label" style="color:var(--finance-color)">FINANCE</div>
                <div class="mon-number" id="mon-num-FINANCE" style="color:var(--finance-color)">---</div>
                <div class="mon-name" id="mon-name-FINANCE">Please wait...</div>
            </div>
            <div class="waiting-list" id="next-list-FINANCE"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDrySDxpUqTMAzom9o1B3ZaGkL__2kx19A",
        authDomain: "ark-queue-system.firebaseapp.com",
        databaseURL: "https://ark-queue-system-default-rtdb.firebaseio.com",
        projectId: "ark-queue-system",
        storageBucket: "ark-queue-system.firebasestorage.app",
        messagingSenderId: "1087161355859",
        appId: "1:1087161355859:web:f17ab0505bc100d0f440a6",
        measurementId: "G-XXEPW2FK59"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let screensaverTimer;
    let currentActiveView = 'monitorView';

    function unlockMenu() { 
        if(prompt("Enter Admin Password:") === "") {
            document.getElementById('mainNav').classList.add('show-menu');
        } 
    }

    function showView(id) {
        currentActiveView = id;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('mainNav').classList.remove('show-menu');
        
        // Disable screensaver immediately if not on monitor
        if(id !== 'monitorView') {
            toggleScreensaver(false);
        } else {
            // Re-trigger idle check for monitor
            resetIdleTimer();
        }
    }

    async function resetSystem() {
        if(confirm("Reset entire system?")) {
            await db.ref('/').update({
                'last_REGISTRAR': 0, 'last_FINANCE': 0,
                'waiting_REGISTRAR': null, 'waiting_FINANCE': null,
                'currentCall': { ticket: '---', name: 'Welcome', dept: 'NONE', time: 0 }
            });
            location.reload();
        }
    }

    function toggleScreensaver(show) {
        const ss = document.getElementById('screensaver-container');
        const video = document.getElementById('idleVideo');
        if (show && currentActiveView === 'monitorView') {
            ss.classList.add('active');
            video.play().catch(e => console.log("Autoplay prevented"));
        } else {
            ss.classList.remove('active');
        }
    }

    function resetIdleTimer() {
        clearTimeout(screensaverTimer);
        screensaverTimer = setTimeout(() => {
            toggleScreensaver(true);
        }, 20000); // 20 seconds of no activity triggers video
    }

    // Monitor Firebase for Calls
    db.ref('currentCall').on('value', (snap) => {
        const data = snap.val();
        if(data && data.dept !== "NONE") {
            // New call made: Hide video instantly
            toggleScreensaver(false);
            resetIdleTimer();

            const numEl = document.getElementById('mon-num-' + data.dept);
            const nameEl = document.getElementById('mon-name-' + data.dept);
            if(numEl) numEl.innerText = data.ticket;
            if(nameEl) nameEl.innerText = data.name;

            const staffDisplay = document.getElementById('current-name-' + data.dept);
            if(staffDisplay) staffDisplay.innerText = data.name + " (" + data.ticket + ")";

            // Voice announcement
            if (Date.now() - data.time < 3000) {
                window.speechSynthesis.cancel();
                const msg = new SpeechSynthesisUtterance(`Now serving, ${data.name}, ticket ${data.ticket}`);
                msg.rate = 0.9;
                window.speechSynthesis.speak(msg);
            }
        } else {
            toggleScreensaver(true);
        }
    });

    // Monitor Waiting Lists
    ['REGISTRAR', 'FINANCE'].forEach(dept => {
        db.ref('waiting_' + dept).on('value', (snap) => {
            const listEl = document.getElementById('next-list-' + dept);
            const countEl = document.getElementById('count-' + dept);
            if(!listEl) return;
            listEl.innerHTML = "";
            let count = 0;
            snap.forEach(child => {
                count++;
                if(count > 4) return; // Show only next 4
                const row = child.val();
                const div = document.createElement('div');
                div.className = 'waiting-row';
                div.innerHTML = `<span>${row.name}</span><span class="wait-ticket">${row.ticket}</span>`;
                listEl.appendChild(div);
            });
            if(countEl) countEl.innerText = count;
        });
    });

    async function callNext(dept) {
        const snap = await db.ref('waiting_' + dept).limitToFirst(1).get();
        if(snap.exists()) {
            const key = Object.keys(snap.val())[0];
            const data = snap.val()[key];
            await db.ref('waiting_' + dept + '/' + key).remove();
            await db.ref('currentCall').set({ 
                ticket: data.ticket, 
                name: data.name, 
                dept: dept, 
                time: Date.now() 
            });
        } else {
            alert("No one is currently waiting for " + dept);
        }
    }

    function switchDept(dept) {
        document.querySelectorAll('.dept-ws').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.staff-sidebar button').forEach(b => b.classList.remove('active-dept'));
        document.getElementById('ws-' + dept).style.display = 'block';
        document.getElementById('btn-tab-' + dept).classList.add('active-dept');
    }

    async function generateTicket(dept, prefix) {
        const nameInput = document.getElementById('studentName');
        const name = nameInput.value.trim();
        if(!name) return alert("Please enter your name!");

        const snap = await db.ref('last_' + dept).get();
        let num = (snap.val() || 0) + 1;
        const ticketID = prefix + num.toString().padStart(3, '0');
        
        await db.ref('last_' + dept).set(num);
        await db.ref('waiting_' + dept).push({ ticket: ticketID, name: name });
        
        document.getElementById('displayTicket').innerText = ticketID;
        document.getElementById('displayTicket').style.color = (dept === 'FINANCE') ? 'var(--finance-color)' : 'var(--registrar-color)';
        document.getElementById('displayName').innerText = name;
        document.getElementById('ticketModal').style.display = 'flex';
        
        nameInput.value = ""; 
        setTimeout(closeModal, 10000); // Auto close after 10s
    }

    function closeModal() {
        document.getElementById('ticketModal').style.display = 'none';
    }

    window.onload = () => {
        if(currentActiveView === 'monitorView') {
            toggleScreensaver(true);
        }
    }
</script>
</body>
</html>
