<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARK Wireless Queue System</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        :root { 
            --registrar-color: #ef4444; 
            --finance-color: #f87171; 
            --dark: #1f1f1f; 
            --body-bg: linear-gradient(135deg, #2a2a2a 0%, #3d3d3d 100%);
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-main: #1f1f1f;
            --text-muted: #6b7280;
            --accent-red: #ef4444;
            --accent-red-light: #f87171;
            --accent-red-lighter: #fca5a5;
            --black-light: #2a2a2a;
            --black-lighter: #404040;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; 
            padding: 0;
            background: var(--body-bg); 
            color: var(--text-main); 
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        /* --- ENHANCED RESPONSIVE FULL SCREEN VIDEO --- */
        #screensaver-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            z-index: 9999;
            background: #000;
            transition: opacity 0.8s ease, visibility 0.8s;
            visibility: hidden;
            opacity: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #screensaver-container.active {
            visibility: visible;
            opacity: 1;
        }

        #screensaver-container video {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            object-position: center;
        }

        /* HEADER - Enhanced */
        .inst-header { 
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
            padding: clamp(1rem, 3vw, 2rem); 
            border-bottom: clamp(4px, 0.5vw, 6px) solid;
            border-image: linear-gradient(90deg, var(--accent-red), var(--accent-red-lighter)) 1;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            position: relative;
            z-index: 100;
            width: 100%;
        }
        .school-logo { 
            height: clamp(50px, 8vw, 80px); 
            width: auto; 
            margin-bottom: clamp(5px, 1vw, 8px);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }
        .school-logo:hover { transform: scale(1.05); }
        
        .inst-header h1 { 
            margin: 0; 
            font-size: clamp(0.9rem, 2.5vw, 2.2rem); 
            font-weight: 800; 
            background: linear-gradient(135deg, var(--accent-red), var(--black-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-transform: uppercase; 
            line-height: 1.3;
            letter-spacing: clamp(0.5px, 0.1vw, 1px);
        }

        .admin-icon {
            transition: all 0.3s ease;
            width: clamp(24px, 3vw, 32px);
            height: auto;
        }
        .admin-icon:hover {
            fill: var(--accent-red);
            transform: scale(1.1);
        }
        
        .header-right {
            position: absolute;
            right: clamp(10px, 2vw, 20px);
            top: clamp(10px, 2vw, 20px);
        }

        /* NAVIGATION - Enhanced */
        nav { 
            background: linear-gradient(135deg, var(--black-light) 0%, var(--black-lighter) 100%);
            padding: clamp(8px, 1.5vw, 12px); 
            display: none; 
            flex-wrap: wrap; 
            gap: clamp(6px, 1vw, 10px); 
            justify-content: center; 
            z-index: 101;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            width: 100%;
        }
        nav.show-menu { display: flex; }
        nav button { 
            background: linear-gradient(135deg, #505050 0%, #606060 100%);
            color: white; 
            border: none; 
            padding: clamp(10px, 1.5vw, 12px) clamp(15px, 2.5vw, 20px); 
            border-radius: clamp(8px, 1.2vw, 12px); 
            cursor: pointer; 
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        nav button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #606060 0%, #707070 100%);
        }
        nav button:active {
            transform: translateY(0);
        }

        /* VIEW CONTAINER */
        .view { 
            display: none; 
            padding: clamp(1rem, 2vw, 1.5rem); 
            width: 100%; 
            flex: 1; 
            overflow-y: auto;
        }
        .view.active { display: flex; flex-direction: column; align-items: center; }

        /* MONITOR UI - Enhanced */
        .monitor-container { 
            display: grid;
            grid-template-columns: 1fr;
            width: 100%; 
            max-width: 1600px;
            gap: clamp(1rem, 2vw, 2rem); 
            margin: auto;
            padding: 0 clamp(0.5rem, 2vw, 0);
        }
        .monitor-panel { 
            background: var(--card-bg); 
            border-radius: clamp(20px, 3vw, 28px); 
            overflow: hidden; 
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            text-align: center;
            border: clamp(2px, 0.3vw, 3px) solid transparent;
            transition: all 0.3s ease;
            position: relative;
            min-height: clamp(400px, 50vh, 600px);
        }
        .monitor-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: clamp(6px, 1vw, 8px);
            background: linear-gradient(90deg, var(--accent-red), var(--accent-red-lighter));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .monitor-panel.calling::before {
            opacity: 1;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .mon-header-label { 
            font-weight: 900; 
            font-size: clamp(1.2rem, 3vw, 2.8rem); 
            letter-spacing: clamp(2px, 0.3vw, 3px); 
            padding: clamp(20px, 3vw, 24px) clamp(15px, 2vw, 20px) clamp(8px, 1vw, 10px);
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .mon-number { 
            font-size: clamp(3rem, 10vw, 9rem); 
            font-weight: 900; 
            font-family: 'Courier New', monospace; 
            margin: clamp(10px, 2vw, 15px) 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.15);
            letter-spacing: clamp(2px, 0.5vw, 4px);
            line-height: 1;
        }
        .mon-name { 
            font-size: clamp(1rem, 2vw, 1.4rem); 
            font-weight: 700; 
            color: var(--text-main); 
            padding-bottom: clamp(20px, 3vw, 24px);
            min-height: 2em;
            padding-left: clamp(10px, 2vw, 20px);
            padding-right: clamp(10px, 2vw, 20px);
        }

        .waiting-list { 
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            padding: clamp(1rem, 2vw, 1.5rem); 
            border-top: 2px solid #e2e8f0; 
            flex: 1;
            overflow-y: auto;
        }
        .waiting-list h4 {
            margin: 0 0 clamp(10px, 1.5vw, 15px) 0;
            color: var(--text-muted);
            font-size: clamp(0.8rem, 1.2vw, 0.9rem);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .waiting-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: clamp(10px, 1.5vw, 12px) clamp(14px, 2vw, 18px); 
            background: white; 
            border-radius: clamp(10px, 1.5vw, 12px); 
            margin-bottom: clamp(8px, 1.2vw, 10px); 
            font-size: clamp(0.9rem, 1.5vw, 1.05rem);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            cursor: default;
        }
        .waiting-row:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        .waiting-row span {
            flex: 1;
            text-align: left;
            padding-right: 10px;
        }
        .waiting-row b {
            flex-shrink: 0;
            font-size: clamp(1rem, 1.8vw, 1.2rem);
        }

        /* KIOSK STYLES - Enhanced */
        .kiosk-card { 
            background: white; 
            padding: clamp(2rem, 4vw, 2.5rem); 
            border-radius: clamp(24px, 4vw, 32px); 
            box-shadow: var(--shadow-lg);
            width: 100%; 
            max-width: clamp(400px, 90vw, 550px); 
            text-align: center;
            border: 3px solid #f1f5f9;
        }
        .kiosk-card h2 {
            background: linear-gradient(135deg, var(--accent-red), var(--black-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: clamp(1.5rem, 4vw, 2rem);
            margin-top: 0;
            margin-bottom: clamp(1.5rem, 3vw, 2rem);
        }
        .name-input { 
            width: 100%; 
            padding: clamp(1.2rem, 2vw, 1.4rem); 
            font-size: clamp(1.1rem, 2vw, 1.3rem); 
            border-radius: clamp(12px, 2vw, 16px); 
            border: 3px solid #e2e8f0; 
            margin-bottom: clamp(1.5rem, 2.5vw, 1.8rem); 
            text-align: center; 
            outline: none;
            transition: all 0.3s ease;
            font-weight: 600;
            box-sizing: border-box;
        }
        .name-input:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
        }
        .btn-reg, .btn-fin { 
            width: 100%; 
            padding: clamp(1.4rem, 2.5vw, 1.6rem); 
            border: none; 
            border-radius: clamp(14px, 2.5vw, 18px); 
            font-weight: 900; 
            font-size: clamp(1.2rem, 2.2vw, 1.4rem); 
            cursor: pointer; 
            margin-bottom: clamp(1rem, 1.5vw, 1.2rem);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        .btn-reg { 
            background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
            color: white;
        }
        .btn-fin { 
            background: linear-gradient(135deg, var(--accent-red-light) 0%, var(--accent-red) 100%);
            color: white;
        }
        .btn-reg:hover, .btn-fin:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }
        .btn-reg:active, .btn-fin:active {
            transform: translateY(-1px);
        }

        /* STAFF PANEL - Enhanced */
        .staff-container { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            max-width: clamp(900px, 95vw, 1100px); 
            background: white; 
            border-radius: clamp(20px, 3vw, 28px); 
            overflow: hidden; 
            box-shadow: var(--shadow-lg);
            border: 3px solid #f1f5f9;
        }
        .staff-sidebar { 
            display: flex; 
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid #e2e8f0;
        }
        .staff-sidebar button { 
            flex: 1; 
            padding: clamp(1.2rem, 2vw, 1.4rem); 
            border: none; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s;
            font-size: clamp(0.85rem, 1.5vw, 1rem);
            text-transform: uppercase;
            letter-spacing: 1px;
            background: transparent;
            color: var(--text-muted);
        }
        .staff-sidebar button.active-dept { 
            background: white; 
            color: var(--accent-red); 
            box-shadow: inset 0 -5px 0 var(--accent-red);
        }
        
        .staff-content {
            flex: 1;
            padding: clamp(1.5rem, 3vw, 2.5rem);
            display: flex;
            flex-direction: column;
            gap: clamp(1.5rem, 2.5vw, 2rem);
        }
        
        .current-ticket-display {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: clamp(15px, 2.5vw, 20px);
            border-radius: clamp(12px, 2vw, 16px);
            border: 2px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
        }
        .current-ticket-display h3 {
            margin: 0 0 clamp(8px, 1.5vw, 10px) 0;
            font-size: clamp(0.8rem, 1.3vw, 0.9rem);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .current-ticket-info {
            font-weight: 700;
            font-size: clamp(1.2rem, 2.5vw, 1.6rem);
            color: var(--text-main);
        }
        
        .staff-actions {
            display: flex;
            gap: clamp(12px, 2vw, 15px);
            justify-content: center;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .call-btn { 
            width: clamp(150px, 25vw, 200px); 
            height: clamp(150px, 25vw, 200px); 
            border-radius: 50%; 
            color: white; 
            border: none;
            font-size: clamp(1.1rem, 2vw, 1.3rem); 
            font-weight: 900; 
            cursor: pointer; 
            transition: all 0.3s;
            box-shadow: var(--shadow-lg);
            text-transform: uppercase;
            letter-spacing: 1px;
            line-height: 1.3;
        }
        .call-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(0,0,0,0.25);
        }
        .call-btn:active {
            transform: scale(0.98);
        }
        
        .repeat-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: clamp(14px, 2vw, 16px) clamp(24px, 4vw, 32px);
            border-radius: clamp(12px, 1.8vw, 14px);
            font-weight: 700;
            font-size: clamp(0.95rem, 1.5vw, 1.1rem);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-md);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .repeat-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .queue-list {
            background: #f8fafc;
            border-radius: clamp(12px, 2vw, 16px);
            padding: clamp(15px, 2.5vw, 20px);
            max-height: clamp(300px, 40vh, 400px);
            overflow-y: auto;
        }
        .queue-list h3 {
            margin: 0 0 clamp(12px, 2vw, 15px) 0;
            color: var(--text-main);
            font-size: clamp(1rem, 1.5vw, 1.1rem);
        }
        .queue-item {
            background: white;
            padding: clamp(12px, 1.8vw, 14px) clamp(14px, 2.2vw, 18px);
            margin-bottom: clamp(8px, 1.2vw, 10px);
            border-radius: clamp(10px, 1.5vw, 12px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
            cursor: pointer;
            gap: clamp(10px, 1.5vw, 15px);
        }
        .queue-item:hover {
            background: #f0f9ff;
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }
        .queue-item-info {
            flex: 1;
            min-width: 0;
        }
        .queue-item-ticket {
            font-weight: 900;
            font-size: clamp(1rem, 1.8vw, 1.2rem);
            color: var(--accent-red);
            font-family: 'Courier New', monospace;
        }
        .queue-item-name {
            font-size: clamp(0.85rem, 1.3vw, 1rem);
            color: var(--text-main);
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .call-specific-btn {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
            border: none;
            padding: clamp(8px, 1.2vw, 10px) clamp(16px, 2.5vw, 20px);
            border-radius: clamp(8px, 1.2vw, 10px);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
            text-transform: uppercase;
            flex-shrink: 0;
        }
        .call-specific-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        /* MODAL - Enhanced */
        #ticketModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            z-index: 10000; 
            justify-content: center; 
            align-items: center; 
            padding: clamp(15px, 3vw, 20px);
            backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: white; 
            padding: clamp(2rem, 4vw, 3rem); 
            border-radius: clamp(24px, 4vw, 32px); 
            text-align: center; 
            width: 100%; 
            max-width: clamp(350px, 90vw, 480px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 4px solid #f1f5f9;
            animation: modalSlideIn 0.4s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .modal-ticket { 
            font-size: clamp(3.5rem, 10vw, 6rem); 
            font-weight: 900; 
            background: linear-gradient(135deg, var(--accent-red), var(--black-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: clamp(12px, 2vw, 15px) 0;
            font-family: 'Courier New', monospace;
            letter-spacing: clamp(2px, 0.5vw, 4px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            line-height: 1;
        }
        .modal-name {
            font-weight: bold; 
            font-size: clamp(1.2rem, 2.5vw, 1.6rem); 
            margin-bottom: clamp(12px, 2vw, 15px);
        }
        .modal-content h2 {
            color: var(--text-muted);
            font-size: clamp(0.9rem, 1.5vw, 1.1rem);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: clamp(1px, 0.2vw, 2px);
            margin: 0;
        }
        .modal-content p {
            color: #64748b; 
            font-size: clamp(1rem, 1.5vw, 1.1rem);
            margin: clamp(12px, 2vw, 15px) 0;
        }
        .modal-content button {
            background: linear-gradient(135deg, var(--black-light), var(--black-lighter));
            color: white;
            border: none;
            padding: clamp(15px, 2.5vw, 18px);
            border-radius: clamp(12px, 2vw, 16px);
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            font-size: clamp(1rem, 1.8vw, 1.2rem);
            transition: all 0.3s;
            box-shadow: var(--shadow-md);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .modal-content button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: linear-gradient(135deg, var(--black-lighter), #505050);
        }

        /* STATS BADGE */
        .stats-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
            padding: clamp(5px, 0.8vw, 6px) clamp(12px, 1.8vw, 14px);
            border-radius: clamp(16px, 2.5vw, 20px);
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
            font-weight: 700;
            margin-left: clamp(8px, 1.2vw, 10px);
        }

        /* --- MEDIA QUERIES --- */
        @media (max-width: 767px) {
            #screensaver-container video {
                object-fit: contain;
            }
            .staff-actions {
                flex-direction: column;
            }
        }

        @media (min-width: 768px) {
            .monitor-container { 
                grid-template-columns: 1fr 1fr; 
            }
            .staff-sidebar { 
                flex-direction: column; 
                width: clamp(180px, 20vw, 220px);
                border-bottom: none;
                border-right: 2px solid #e2e8f0;
            }
            .staff-container { 
                flex-direction: row; 
                min-height: clamp(500px, 60vh, 600px); 
            }
            .staff-sidebar button.active-dept { 
                box-shadow: inset -5px 0 0 var(--accent-red);
            }
        }

        @media (min-width: 1024px) {
            .monitor-container {
                gap: clamp(2rem, 3vw, 3rem);
            }
        }

        /* Landscape mode for tablets and small screens */
        @media (max-width: 900px) and (orientation: landscape) {
            .monitor-panel {
                min-height: auto;
            }
            .mon-number {
                margin: 8px 0;
            }
            .waiting-list {
                max-height: 25vh;
            }
        }

        /* LOGIN & USER MANAGEMENT STYLES */
        .login-modal, .user-modal, .settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .login-box, .user-box, .settings-box {
            background: white;
            padding: clamp(2rem, 4vw, 3rem);
            border-radius: clamp(20px, 3vw, 28px);
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
        }
        
        .settings-box {
            max-width: 700px;
        }
        
        .login-box h2, .user-box h2, .settings-box h2 {
            margin-top: 0;
            background: linear-gradient(135deg, var(--accent-red), var(--black-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: clamp(1.5rem, 3vw, 2rem);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-main);
            font-size: clamp(0.9rem, 1.5vw, 1rem);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: clamp(0.8rem, 1.5vw, 1rem);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: clamp(0.9rem, 1.5vw, 1rem);
            outline: none;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .form-input:focus, .form-select:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        
        .btn-primary, .btn-secondary, .btn-danger {
            width: 100%;
            padding: clamp(0.8rem, 1.5vw, 1rem);
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: clamp(0.9rem, 1.5vw, 1rem);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--black-light), var(--black-lighter));
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--black-lighter), #505050);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }
        
        .user-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 1.5rem 0;
        }
        
        .user-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-email {
            font-weight: 600;
            color: var(--text-main);
        }
        
        .user-role {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }
        
        .user-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .user-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-approve {
            background: var(--accent-red);
            color: white;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .file-upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 1rem 0;
        }
        
        .file-upload-area:hover {
            border-color: var(--accent-red);
            background: #fef2f2;
        }
        
        .file-upload-area.dragover {
            border-color: var(--accent-red);
            background: #fee2e2;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 100px;
            margin: 1rem auto;
            display: block;
            border-radius: 8px;
        }
        
        .theme-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .theme-option {
            padding: 1.5rem;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .theme-option.active {
            border-color: var(--accent-red);
            background: #fef2f2;
        }
        
        .theme-option:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .color-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 0.8rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: var(--accent-red);
            border-bottom-color: var(--accent-red);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .logout-btn {
            position: absolute;
            top: clamp(10px, 2vw, 20px);
            right: clamp(50px, 8vw, 80px);
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
            border: none;
            padding: clamp(8px, 1.2vw, 10px) clamp(16px, 2.5vw, 20px);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: clamp(0.75rem, 1.2vw, 0.85rem);
            display: none;
            z-index: 1000;
        }
        
        .logout-btn.show {
            display: block;
        }
    </style>
</head>
<body>

<div id="screensaver-container">
    <video id="idleVideo" muted loop playsinline>
        <source src="videos/MAKERTING2023.mp4" type="video/mp4">
    </video>
</div>

<div id="ticketModal">
    <div class="modal-content">
        <h2>YOUR TICKET NUMBER</h2>
        <div class="modal-ticket" id="displayTicket">---</div>
        <div class="modal-name" id="displayName">---</div>
        <p>Please take a photo of your ticket.</p>
        <button onclick="closeModal()">OK, GOT IT</button>
    </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="login-modal">
    <div class="login-box">
        <h2>üîê Staff Login</h2>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password">
        </div>
        <button class="btn-primary" onclick="login()">Login</button>
        <button class="btn-secondary" onclick="showRegister()">Register New Account</button>
    </div>
</div>

<!-- Register Modal -->
<div id="registerModal" class="login-modal">
    <div class="login-box">
        <h2>üìù Register Account</h2>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="regEmail" class="form-input" placeholder="Enter your email">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="regPassword" class="form-input" placeholder="Enter your password">
        </div>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="regName" class="form-input" placeholder="Enter your full name">
        </div>
        <div class="form-group">
            <label>Department</label>
            <select id="regDept" class="form-select">
                <option value="REGISTRAR">Registrar</option>
                <option value="FINANCE">Finance</option>
            </select>
        </div>
        <button class="btn-primary" onclick="register()">Register</button>
        <button class="btn-secondary" onclick="showLogin()">Back to Login</button>
    </div>
</div>

<!-- User Management Modal -->
<div id="userModal" class="user-modal">
    <div class="user-box">
        <h2>üë• User Management</h2>
        <div class="user-list" id="userList"></div>
        <button class="btn-secondary" onclick="closeUserModal()">Close</button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="settings-modal">
    <div class="settings-box">
        <h2>‚öôÔ∏è Settings</h2>
        
        <div class="tabs">
            <button class="tab active" onclick="switchSettingsTab('theme')">Theme</button>
            <button class="tab" onclick="switchSettingsTab('branding')">Branding</button>
            <button class="tab" onclick="switchSettingsTab('media')">Screensaver</button>
        </div>
        
        <!-- Theme Tab -->
        <div id="themeTab" class="tab-content active">
            <h3>Select Theme</h3>
            <div class="theme-selector">
                <div class="theme-option" onclick="selectTheme('red-black')" data-theme="red-black">
                    <div class="color-preview" style="background: linear-gradient(135deg, #ef4444, #1f1f1f);"></div>
                    <div>Red & Black</div>
                </div>
                <div class="theme-option" onclick="selectTheme('blue-dark')" data-theme="blue-dark">
                    <div class="color-preview" style="background: linear-gradient(135deg, #3b82f6, #1e293b);"></div>
                    <div>Blue & Dark</div>
                </div>
                <div class="theme-option" onclick="selectTheme('green-black')" data-theme="green-black">
                    <div class="color-preview" style="background: linear-gradient(135deg, #10b981, #1f1f1f);"></div>
                    <div>Green & Black</div>
                </div>
                <div class="theme-option" onclick="selectTheme('purple-dark')" data-theme="purple-dark">
                    <div class="color-preview" style="background: linear-gradient(135deg, #a855f7, #1e293b);"></div>
                    <div>Purple & Dark</div>
                </div>
            </div>
        </div>
        
        <!-- Branding Tab -->
        <div id="brandingTab" class="tab-content">
            <h3>Upload Logo</h3>
            <div class="file-upload-area" onclick="document.getElementById('logoUpload').click()">
                <p>üìÅ Click or drag logo image here</p>
                <input type="file" id="logoUpload" accept="image/*" style="display:none" onchange="uploadLogo(this)">
            </div>
            <img id="logoPreview" class="preview-image" style="display:none">
            
            <div class="form-group">
                <label>Institution Name</label>
                <input type="text" id="institutionName" class="form-input" placeholder="ARK Technological Institute">
            </div>
            <div class="form-group">
                <label>Subtitle</label>
                <input type="text" id="institutionSubtitle" class="form-input" placeholder="Education System Inc.">
            </div>
        </div>
        
        <!-- Media Tab -->
        <div id="mediaTab" class="tab-content">
            <h3>Upload Screensaver Media</h3>
            <div class="file-upload-area" onclick="document.getElementById('mediaUpload').click()">
                <p>üé• Click or drag video/image here</p>
                <input type="file" id="mediaUpload" accept="video/*,image/*" style="display:none" onchange="uploadMedia(this)">
            </div>
            <div id="mediaPreview"></div>
            <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 1rem;">
                Supported formats: MP4, WebM for videos | JPG, PNG for images
            </p>
        </div>
        
        <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
        <button class="btn-secondary" onclick="closeSettings()">Close</button>
    </div>
</div>

<header class="inst-header">
    <img src="images/logo.png" alt="ARK Logo" class="school-logo" id="headerLogo">
    <h1 id="headerTitle">ARK Technological Institute <br><span id="headerSubtitle">Education System Inc.</span></h1>
    <button class="logout-btn" id="logoutBtn" onclick="logout()">Logout</button>
    <div class="header-right">
        <svg class="admin-icon" onclick="unlockMenu()" viewBox="0 0 24 24" style="fill:#cbd5e1; cursor:pointer;">
            <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/><path d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z"/>
        </svg>
    </div>
</header>

<nav id="mainNav">
    <button onclick="showView('kioskView')">üé´ KIOSK MODE</button>
    <button onclick="showView('staffView')">üëî STAFF PANEL</button>
    <button onclick="showView('monitorView')">üì∫ MONITOR SCREEN</button>
    <button id="resetBtn" onclick="resetDepartment()" style="background: linear-gradient(135deg, #f59e0b, #d97706); display:none;">üîÑ RESET DEPARTMENT</button>
    <button id="adminResetBtn" onclick="resetSystem()" style="background: linear-gradient(135deg, #ef4444, #dc2626); display:none;">üîÑ RESET SYSTEM</button>
    <button id="userMgmtBtn" onclick="showUserManagement()" style="background: linear-gradient(135deg, #3b82f6, #2563eb); display:none;">üë• USERS</button>
    <button id="settingsBtn" onclick="showSettings()" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); display:none;">‚öôÔ∏è SETTINGS</button>
</nav>

<div id="kioskView" class="view">
    <div class="kiosk-card">
        <h2>Queue Registration</h2>
        <input type="text" id="studentName" class="name-input" placeholder="Enter Full Name">
        <button class="btn-reg" onclick="generateTicket('REGISTRAR', 'R')">üìã REGISTRAR</button>
        <button class="btn-fin" onclick="generateTicket('FINANCE', 'F')">üí∞ FINANCE</button>
    </div>
</div>

<div id="staffView" class="view">
    <div class="staff-container">
        <div class="staff-sidebar">
            <button id="btn-tab-REGISTRAR" onclick="switchDept('REGISTRAR')" class="active-dept">REGISTRAR</button>
            <button id="btn-tab-FINANCE" onclick="switchDept('FINANCE')">FINANCE</button>
        </div>
        <div class="staff-content">
            <div id="ws-REGISTRAR" class="dept-ws">
                <h2 style="color:var(--accent-red); margin-top: 0; font-size: 1.8rem;">
                    üìã Registrar Counter
                    <span class="stats-badge" id="count-REGISTRAR">0</span>
                </h2>
                
                <div class="current-ticket-display">
                    <h3>Currently Serving</h3>
                    <div class="current-ticket-info" id="current-name-REGISTRAR">---</div>
                </div>
                
                <div class="staff-actions">
                    <button class="call-btn" style="background: linear-gradient(135deg, var(--accent-red), #dc2626)" onclick="callNext('REGISTRAR')">
                        CALL<br>NEXT
                    </button>
                    <button class="repeat-btn" onclick="repeatCall('REGISTRAR')">
                        üîä REPEAT CALL
                    </button>
                </div>
                
                <div class="queue-list">
                    <h3>üìã Queue List</h3>
                    <div id="queue-list-REGISTRAR"></div>
                </div>
            </div>
            
            <div id="ws-FINANCE" class="dept-ws" style="display:none;">
                <h2 style="color:var(--accent-red-light); margin-top: 0; font-size: 1.8rem;">
                    üí∞ Finance Counter
                    <span class="stats-badge" style="background: linear-gradient(135deg, var(--accent-red-light), var(--accent-red));" id="count-FINANCE">0</span>
                </h2>
                
                <div class="current-ticket-display">
                    <h3>Currently Serving</h3>
                    <div class="current-ticket-info" id="current-name-FINANCE">---</div>
                </div>
                
                <div class="staff-actions">
                    <button class="call-btn" style="background: linear-gradient(135deg, var(--accent-red-light), var(--accent-red))" onclick="callNext('FINANCE')">
                        CALL<br>NEXT
                    </button>
                    <button class="repeat-btn" onclick="repeatCall('FINANCE')">
                        üîä REPEAT CALL
                    </button>
                </div>
                
                <div class="queue-list">
                    <h3>üìã Queue List</h3>
                    <div id="queue-list-FINANCE"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="monitorView" class="view active">
    <div class="monitor-container">
        <div class="monitor-panel" id="panel-REGISTRAR">
            <div class="mon-header-label" style="color:var(--accent-red)">üìã REGISTRAR</div>
            <div class="mon-number" id="mon-num-REGISTRAR" style="color:var(--accent-red)">---</div>
            <div class="mon-name" id="mon-name-REGISTRAR">Welcome</div>
            <div class="waiting-list">
                <h4>Next in Queue</h4>
                <div id="next-list-REGISTRAR"></div>
            </div>
        </div>
        <div class="monitor-panel" id="panel-FINANCE">
            <div class="mon-header-label" style="color:var(--accent-red-light)">üí∞ FINANCE</div>
            <div class="mon-number" id="mon-num-FINANCE" style="color:var(--accent-red-light)">---</div>
            <div class="mon-name" id="mon-name-FINANCE">Welcome</div>
            <div class="waiting-list">
                <h4>Next in Queue</h4>
                <div id="next-list-FINANCE"></div>
            </div>
        </div>
    </div>
</div>

<!-- Bell Sound - Embedded as Data URI -->
<audio id="bellSound" preload="auto">
    <source src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAASAAAeMwAUFBQUFCIiIiIiIjAwMDAwPj4+Pj4+TExMTExZWVlZWVlnZ2dnZ3V1dXV1dYODg4ODkZGRkZGRn5+fn5+frKysrKy6urq6urrIyMjIyNbW1tbW1uTk5OTk8vLy8vLy//////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAQKAAAAAAAAHjOZTf9/AAAAAAAAAAAAAAAAAAAAAP/7UsAAAP8AAAaQAAAAgAAA0gAAABAAABpAAAACAAADSAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//sUwAP8AAAGkAAAAIAAANIAAAAQAAAaQAAAAgAAA0gAAABFVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV" type="audio/mpeg">
</audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDrySDxpUqTMAzom9o1B3ZaGkL__2kx19A",
        authDomain: "ark-queue-system.firebaseapp.com",
        databaseURL: "https://ark-queue-system-default-rtdb.firebaseio.com",
        projectId: "ark-queue-system",
        storageBucket: "ark-queue-system.firebasestorage.app",
        messagingSenderId: "1087161355859",
        appId: "1:1087161355859:web:f17ab0505bc100d0f440a6",
        measurementId: "G-XXEPW2FK59"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const storage = firebase.storage();
    
    let screensaverTimer;
    let currentActiveView = 'monitorView';
    let lastCalled = { REGISTRAR: null, FINANCE: null };
    let queueData = { REGISTRAR: {}, FINANCE: {} };
    let currentUser = null;
    let currentUserData = null;

    // ============= AUTHENTICATION & USER MANAGEMENT =============
    
    async function initializeDefaultAdmin() {
        try {
            // Check if default admin exists
            const adminSnapshot = await db.ref('users').orderByChild('email').equalTo('reymonde.silvestre@gmail.com').once('value');
            
            if (!adminSnapshot.exists()) {
                // Create default admin account
                const adminUser = await auth.createUserWithEmailAndPassword('reymonde.silvestre@gmail.com', 'admin123');
                await db.ref('users/' + adminUser.user.uid).set({
                    email: 'reymonde.silvestre@gmail.com',
                    name: 'Administrator',
                    role: 'admin',
                    department: 'ALL',
                    status: 'approved',
                    createdAt: Date.now()
                });
                console.log('Default admin account created');
            }
        } catch (error) {
            console.log('Admin initialization:', error.message);
        }
    }

    function showLogin() {
        document.getElementById('loginModal').style.display = 'flex';
        document.getElementById('registerModal').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('registerModal').style.display = 'flex';
        document.getElementById('loginModal').style.display = 'none';
    }

    async function login() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            alert('Please fill in all fields');
            return;
        }

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const userData = await db.ref('users/' + userCredential.user.uid).once('value');
            
            if (!userData.exists()) {
                await auth.signOut();
                alert('User data not found');
                return;
            }

            const data = userData.val();
            if (data.status !== 'approved') {
                await auth.signOut();
                alert('Your account is pending approval. Please contact the administrator.');
                return;
            }

            currentUser = userCredential.user;
            currentUserData = data;
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('logoutBtn').classList.add('show');
            updateUIForRole();
            
        } catch (error) {
            alert('Login failed: ' + error.message);
        }
    }

    async function register() {
        const email = document.getElementById('regEmail').value.trim();
        const password = document.getElementById('regPassword').value;
        const name = document.getElementById('regName').value.trim();
        const dept = document.getElementById('regDept').value;
        
        if (!email || !password || !name) {
            alert('Please fill in all fields');
            return;
        }

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            await db.ref('users/' + userCredential.user.uid).set({
                email: email,
                name: name,
                role: 'staff',
                department: dept,
                status: 'pending',
                createdAt: Date.now()
            });
            
            await auth.signOut();
            alert('Registration successful! Your account is pending admin approval.');
            showLogin();
            
            // Clear form
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regName').value = '';
            
        } catch (error) {
            alert('Registration failed: ' + error.message);
        }
    }

    async function logout() {
        await auth.signOut();
        currentUser = null;
        currentUserData = null;
        document.getElementById('logoutBtn').classList.remove('show');
        document.getElementById('mainNav').classList.remove('show-menu');
        showLogin();
    }

    function updateUIForRole() {
        const isAdmin = currentUserData?.role === 'admin';
        const isStaff = currentUserData?.role === 'staff';
        
        // Show/hide buttons based on role
        document.getElementById('resetBtn').style.display = isStaff ? 'inline-block' : 'none';
        document.getElementById('adminResetBtn').style.display = isAdmin ? 'inline-block' : 'none';
        document.getElementById('userMgmtBtn').style.display = isAdmin ? 'inline-block' : 'none';
        document.getElementById('settingsBtn').style.display = isAdmin ? 'inline-block' : 'none';
    }

    // ============= USER MANAGEMENT =============
    
    async function showUserManagement() {
        const userList = document.getElementById('userList');
        userList.innerHTML = '<p style="text-align:center;">Loading...</p>';
        document.getElementById('userModal').style.display = 'flex';
        
        const usersSnapshot = await db.ref('users').once('value');
        userList.innerHTML = '';
        
        usersSnapshot.forEach(userSnap => {
            const user = userSnap.val();
            const userId = userSnap.key;
            
            const userItem = document.createElement('div');
            userItem.className = 'user-item';
            userItem.innerHTML = `
                <div class="user-info">
                    <div class="user-email">${user.email}</div>
                    <div class="user-role">${user.role} - ${user.department}</div>
                </div>
                <span class="user-status status-${user.status}">${user.status}</span>
                <div class="user-actions">
                    ${user.status === 'pending' ? `<button class="btn-small btn-approve" onclick="approveUser('${userId}')">Approve</button>` : ''}
                    ${user.role !== 'admin' ? `<button class="btn-small btn-delete" onclick="deleteUser('${userId}')">Delete</button>` : ''}
                </div>
            `;
            userList.appendChild(userItem);
        });
    }

    async function approveUser(userId) {
        if (confirm('Approve this user?')) {
            await db.ref('users/' + userId).update({ status: 'approved' });
            showUserManagement();
        }
    }

    async function deleteUser(userId) {
        if (confirm('Delete this user? This action cannot be undone.')) {
            await db.ref('users/' + userId).remove();
            // Note: You may also want to delete the auth user, but that requires admin SDK
            showUserManagement();
        }
    }

    function closeUserModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    // ============= SETTINGS MANAGEMENT =============
    
    let settingsData = {
        theme: 'red-black',
        logoUrl: 'images/logo.png',
        institutionName: 'ARK Technological Institute',
        institutionSubtitle: 'Education System Inc.',
        screensaverUrl: 'videos/MAKERTING2023.mp4',
        screensaverType: 'video'
    };

    async function loadSettings() {
        const settingsSnap = await db.ref('settings').once('value');
        if (settingsSnap.exists()) {
            settingsData = { ...settingsData, ...settingsSnap.val() };
            applySettings();
        }
    }

    function applySettings() {
        // Apply logo
        const logo = document.getElementById('headerLogo');
        if (logo && settingsData.logoUrl) {
            logo.src = settingsData.logoUrl;
        }
        
        // Apply institution name
        const titleEl = document.getElementById('headerTitle');
        if (titleEl) {
            const subtitle = document.getElementById('headerSubtitle');
            titleEl.innerHTML = `${settingsData.institutionName} <br><span id="headerSubtitle">${settingsData.institutionSubtitle}</span>`;
        }
        
        // Apply screensaver
        const video = document.getElementById('idleVideo');
        if (video && settingsData.screensaverUrl) {
            if (settingsData.screensaverType === 'video') {
                video.src = settingsData.screensaverUrl;
                video.style.display = 'block';
            } else {
                // For images, convert video element to image
                const container = document.getElementById('screensaver-container');
                container.innerHTML = `<img src="${settingsData.screensaverUrl}" style="width:100%; height:100%; object-fit:cover;">`;
            }
        }
        
        // Apply theme
        applyTheme(settingsData.theme);
    }

    function showSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        
        // Load current settings into form
        document.getElementById('institutionName').value = settingsData.institutionName;
        document.getElementById('institutionSubtitle').value = settingsData.institutionSubtitle;
        
        // Mark active theme
        document.querySelectorAll('.theme-option').forEach(opt => {
            opt.classList.remove('active');
            if (opt.dataset.theme === settingsData.theme) {
                opt.classList.add('active');
            }
        });
    }

    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function switchSettingsTab(tabName) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
    }

    function selectTheme(themeName) {
        settingsData.theme = themeName;
        document.querySelectorAll('.theme-option').forEach(opt => {
            opt.classList.remove('active');
            if (opt.dataset.theme === themeName) {
                opt.classList.add('active');
            }
        });
    }

    function applyTheme(themeName) {
        const root = document.documentElement;
        
        const themes = {
            'red-black': {
                registrar: '#ef4444',
                finance: '#f87171',
                dark: '#1f1f1f',
                bodyBg: 'linear-gradient(135deg, #2a2a2a 0%, #3d3d3d 100%)'
            },
            'blue-dark': {
                registrar: '#3b82f6',
                finance: '#60a5fa',
                dark: '#1e293b',
                bodyBg: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)'
            },
            'green-black': {
                registrar: '#10b981',
                finance: '#34d399',
                dark: '#1f1f1f',
                bodyBg: 'linear-gradient(135deg, #1f2937 0%, #374151 100%)'
            },
            'purple-dark': {
                registrar: '#a855f7',
                finance: '#c084fc',
                dark: '#1e293b',
                bodyBg: 'linear-gradient(135deg, #312e81 0%, #4c1d95 100%)'
            }
        };
        
        const theme = themes[themeName];
        if (theme) {
            root.style.setProperty('--registrar-color', theme.registrar);
            root.style.setProperty('--finance-color', theme.finance);
            root.style.setProperty('--accent-red', theme.registrar);
            root.style.setProperty('--accent-red-light', theme.finance);
            root.style.setProperty('--dark', theme.dark);
            root.style.setProperty('--black-light', theme.dark);
            document.body.style.background = theme.bodyBg;
        }
    }

    async function uploadLogo(input) {
        const file = input.files[0];
        if (!file) return;
        
        const preview = document.getElementById('logoPreview');
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        
        // Upload to Firebase Storage
        const storageRef = storage.ref('logos/' + Date.now() + '_' + file.name);
        await storageRef.put(file);
        settingsData.logoUrl = await storageRef.getDownloadURL();
    }

    async function uploadMedia(input) {
        const file = input.files[0];
        if (!file) return;
        
        const previewDiv = document.getElementById('mediaPreview');
        const isVideo = file.type.startsWith('video/');
        
        if (isVideo) {
            previewDiv.innerHTML = `<video src="${URL.createObjectURL(file)}" controls style="max-width:100%; max-height:200px; margin-top:1rem; border-radius:12px;"></video>`;
            settingsData.screensaverType = 'video';
        } else {
            previewDiv.innerHTML = `<img src="${URL.createObjectURL(file)}" style="max-width:100%; max-height:200px; margin-top:1rem; border-radius:12px;">`;
            settingsData.screensaverType = 'image';
        }
        
        // Upload to Firebase Storage
        const storageRef = storage.ref('screensavers/' + Date.now() + '_' + file.name);
        await storageRef.put(file);
        settingsData.screensaverUrl = await storageRef.getDownloadURL();
    }

    async function saveSettings() {
        settingsData.institutionName = document.getElementById('institutionName').value;
        settingsData.institutionSubtitle = document.getElementById('institutionSubtitle').value;
        
        await db.ref('settings').set(settingsData);
        applySettings();
        alert('Settings saved successfully!');
        closeSettings();
    }

    // ============= MENU & NAVIGATION =============
    
    function unlockMenu() {
        if (currentUser) {
            document.getElementById('mainNav').classList.add('show-menu');
        } else {
            showLogin();
        }
    }

    function showView(id) {
        currentActiveView = id;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('mainNav').classList.remove('show-menu');
        if(id !== 'monitorView') {
            toggleScreensaver(false);
        } else {
            resetIdleTimer();
        }
    }

    async function resetDepartment() {
        if (!currentUserData || currentUserData.role !== 'staff') return;
        
        const dept = currentUserData.department;
        if (confirm(`Reset ${dept} department queue numbers?`)) {
            await db.ref('last_' + dept).set(0);
            await db.ref('waiting_' + dept).remove();
            alert(`${dept} queue reset successfully!`);
        }
    }

    async function resetSystem() {
        if (!currentUserData || currentUserData.role !== 'admin') return;
        
        if(confirm("Are you sure you want to reset ALL ticket counts?")) {
            await db.ref('/').update({
                'last_REGISTRAR': 0, 'last_FINANCE': 0,
                'waiting_REGISTRAR': null, 'waiting_FINANCE': null,
                'currentCall': { ticket: '---', name: 'Welcome', dept: 'NONE', time: 0 }
            });
            alert('System reset successfully!');
            location.reload();
        }
    }

    // ============= SCREENSAVER =============
    
    function toggleScreensaver(show) {
        const ss = document.getElementById('screensaver-container');
        const video = document.getElementById('idleVideo');
        if (show && currentActiveView === 'monitorView') {
            ss.classList.add('active');
            if (video && video.tagName === 'VIDEO') {
                video.play().catch(() => console.log("User interaction required for video"));
            }
        } else {
            ss.classList.remove('active');
            if (video && video.tagName === 'VIDEO') {
                video.pause();
            }
        }
    }

    function resetIdleTimer() {
        clearTimeout(screensaverTimer);
        screensaverTimer = setTimeout(() => {
            toggleScreensaver(true);
        }, 25000); 
    }

    // ============= AUDIO =============
    
    function playBellSound() {
        const bell = document.getElementById('bellSound');
        bell.currentTime = 0;
        bell.play().catch(e => console.log("Bell sound failed:", e));
    }

    function announceTicket(name, ticket) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(`Now serving ${name}. Ticket ${ticket}`);
        msg.rate = 0.85;
        msg.pitch = 1.0;
        msg.volume = 1.0;
        window.speechSynthesis.speak(msg);
    }

    // ============= DATABASE LISTENERS =============
    
    db.ref('currentCall').on('value', (snap) => {
        const data = snap.val();
        if(data && data.dept !== "NONE") {
            toggleScreensaver(false);
            resetIdleTimer();

            const numEl = document.getElementById('mon-num-' + data.dept);
            const nameEl = document.getElementById('mon-name-' + data.dept);
            const panelEl = document.getElementById('panel-' + data.dept);
            
            if(numEl) numEl.innerText = data.ticket;
            if(nameEl) nameEl.innerText = data.name;

            const staffDisplay = document.getElementById('current-name-' + data.dept);
            if(staffDisplay) staffDisplay.innerText = `${data.name} (${data.ticket})`;

            if(panelEl) {
                panelEl.classList.add('calling');
                setTimeout(() => panelEl.classList.remove('calling'), 3000);
            }

            if (Date.now() - data.time < 3000) {
                playBellSound();
                setTimeout(() => announceTicket(data.name, data.ticket), 500);
            }

            lastCalled[data.dept] = data;
        }
    });

    ['REGISTRAR', 'FINANCE'].forEach(dept => {
        db.ref('waiting_' + dept).on('value', (snap) => {
            const monitorListEl = document.getElementById('next-list-' + dept);
            const queueListEl = document.getElementById('queue-list-' + dept);
            const countEl = document.getElementById('count-' + dept);
            
            queueData[dept] = {};
            let count = 0;

            if(monitorListEl) monitorListEl.innerHTML = "";
            if(queueListEl) queueListEl.innerHTML = "";

            snap.forEach(child => {
                const row = child.val();
                queueData[dept][child.key] = row;
                count++;

                // Monitor display - show first 5
                if(count <= 5 && monitorListEl) {
                    const div = document.createElement('div');
                    div.className = 'waiting-row';
                    const color = dept === 'REGISTRAR' ? 'var(--accent-red)' : 'var(--accent-red-light)';
                    div.innerHTML = `<span>${row.name}</span><b style="color:${color}">${row.ticket}</b>`;
                    monitorListEl.appendChild(div);
                }

                // Staff queue list - show all with call buttons
                if(queueListEl) {
                    const queueItem = document.createElement('div');
                    queueItem.className = 'queue-item';
                    queueItem.innerHTML = `
                        <div class="queue-item-info">
                            <div class="queue-item-ticket">${row.ticket}</div>
                            <div class="queue-item-name">${row.name}</div>
                        </div>
                        <button class="call-specific-btn" onclick="callSpecific('${dept}', '${child.key}')">
                            Call
                        </button>
                    `;
                    queueListEl.appendChild(queueItem);
                }
            });

            if(countEl) countEl.innerText = count;
            
            if(queueListEl && count === 0) {
                queueListEl.innerHTML = '<p style="text-align:center; color: var(--text-muted); padding: 20px;">No students in queue</p>';
            }
        });
    });

    // ============= QUEUE FUNCTIONS =============
    
    async function callNext(dept) {
        const snap = await db.ref('waiting_' + dept).limitToFirst(1).get();
        if(snap.exists()) {
            const key = Object.keys(snap.val())[0];
            const data = snap.val()[key];
            await db.ref('waiting_' + dept + '/' + key).remove();
            await db.ref('currentCall').set({ 
                ticket: data.ticket, 
                name: data.name, 
                dept: dept, 
                time: Date.now() 
            });
        } else {
            alert("No students in queue.");
        }
    }

    async function callSpecific(dept, key) {
        const snap = await db.ref('waiting_' + dept + '/' + key).get();
        if(snap.exists()) {
            const data = snap.val();
            await db.ref('waiting_' + dept + '/' + key).remove();
            await db.ref('currentCall').set({ 
                ticket: data.ticket, 
                name: data.name, 
                dept: dept, 
                time: Date.now() 
            });
        }
    }

    function repeatCall(dept) {
        if(lastCalled[dept]) {
            playBellSound();
            setTimeout(() => announceTicket(lastCalled[dept].name, lastCalled[dept].ticket), 500);
        } else {
            alert("No ticket to repeat.");
        }
    }

    function switchDept(dept) {
        document.querySelectorAll('.dept-ws').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.staff-sidebar button').forEach(b => b.classList.remove('active-dept'));
        document.getElementById('ws-' + dept).style.display = 'block';
        document.getElementById('btn-tab-' + dept).classList.add('active-dept');
    }

    async function generateTicket(dept, prefix) {
        const input = document.getElementById('studentName');
        const name = input.value.trim();
        if(!name) return alert("Please enter your name");

        const snap = await db.ref('last_' + dept).get();
        let num = (snap.val() || 0) + 1;
        const ticketID = prefix + num.toString().padStart(3, '0');
        
        await db.ref('last_' + dept).set(num);
        await db.ref('waiting_' + dept).push({ ticket: ticketID, name: name });
        
        document.getElementById('displayTicket').innerText = ticketID;
        document.getElementById('displayName').innerText = name;
        document.getElementById('ticketModal').style.display = 'flex';
        
        input.value = ""; 
        setTimeout(closeModal, 8000);
    }

    function closeModal() {
        document.getElementById('ticketModal').style.display = 'none';
    }

    // ============= INITIALIZATION =============
    
    window.onload = async () => {
        await initializeDefaultAdmin();
        await loadSettings();
        
        // Auto-login for kiosk and monitor modes
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const userData = await db.ref('users/' + user.uid).once('value');
                if (userData.exists() && userData.val().status === 'approved') {
                    currentUser = user;
                    currentUserData = userData.val();
                    document.getElementById('logoutBtn').classList.add('show');
                    updateUIForRole();
                } else {
                    await auth.signOut();
                    showLogin();
                }
            } else {
                // Auto-show monitor for public display
                if (currentActiveView === 'monitorView') {
                    resetIdleTimer();
                } else {
                    showLogin();
                }
            }
        });
    }
</script>
</body>
</html>
