<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ARK Queue System with Login</title>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;margin:0}
.hidden{display:none}
.login-box{max-width:400px;margin:80px auto;background:#fff;padding:30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
input,button{width:100%;padding:12px;margin:8px 0}
button{background:#2563eb;color:#fff;border:none;font-weight:bold;cursor:pointer}
.admin{background:#dc2626}
nav button{margin:5px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" class="login-box hidden">
  <h2>Staff / Admin Login</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">LOGIN</button>
  <p id="loginError" style="color:red"></p>
</div>

<!-- NAV -->
<nav id="nav" class="hidden">
  <button onclick="showView('kiosk')">Kiosk</button>
  <button onclick="showView('monitor')">Monitor</button>
  <button onclick="showView('staff')">Staff Panel</button>
  <button onclick="logout()" class="admin">Logout</button>
</nav>

<!-- VIEWS -->
<div id="kiosk" class="hidden"><h1>KIOSK MODE</h1></div>
<div id="monitor" class="hidden"><h1>MONITOR SCREEN</h1></div>

<div id="staff" class="hidden">
  <h1>STAFF PANEL</h1>
  <button onclick="resetSystem()" class="admin">RESET SYSTEM</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrySDxpUqTMAzom9o1B3ZaGkL__2kx19A",
  authDomain: "ark-queue-system.firebaseapp.com",
  databaseURL: "https://ark-queue-system-default-rtdb.firebaseio.com",
  projectId: "ark-queue-system"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const ADMIN_EMAIL = "reymonde.silvestre@gmail.com";
const ADMIN_PASS = "admin123";

function showView(id){
  document.querySelectorAll("div").forEach(d=>d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  document.getElementById("nav").classList.remove("hidden");
}

function logout(){
  auth.signOut();
  location.reload();
}

async function login(){
  try{
    const email=document.getElementById("email").value;
    const pass=document.getElementById("password").value;
    const cred=await auth.signInWithEmailAndPassword(email,pass);
    checkRole(cred.user);
  }catch(e){
    document.getElementById("loginError").innerText=e.message;
  }
}

function resetSystem(){
  if(confirm("RESET ALL QUEUES?")){
    db.ref("/").remove();
    alert("System Reset");
  }
}

// AUTO LOGIN FOR KIOSK & MONITOR
auth.onAuthStateChanged(async user=>{
  if(!user){
    await auth.signInAnonymously();
    showView("monitor");
    return;
  }

  if(user.isAnonymous){
    showView("monitor");
    return;
  }

  checkRole(user);
});

// ROLE CHECK
async function checkRole(user){
  const snap = await db.ref("users/"+user.uid).get();

  // Create default admin
  if(user.email===ADMIN_EMAIL){
    db.ref("users/"+user.uid).set({
      email:user.email,
      role:"admin",
      approved:true
    });
    showView("staff");
    return;
  }

  if(!snap.exists()){
    db.ref("users/"+user.uid).set({
      email:user.email,
      role:"staff",
      approved:false
    });
    alert("Waiting for admin approval");
    logout();
    return;
  }

  const data=snap.val();
  if(!data.approved){
    alert("Account not approved");
    logout();
    return;
  }

  showView("staff");
}

// CREATE DEFAULT ADMIN (FIRST LOAD)
auth.signInWithEmailAndPassword(ADMIN_EMAIL,ADMIN_PASS)
.catch(()=>{
  auth.createUserWithEmailAndPassword(ADMIN_EMAIL,ADMIN_PASS);
});
</script>

</body>
</html>
